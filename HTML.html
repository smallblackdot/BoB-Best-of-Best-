<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Victims, Shelters & Repositories Display</title>
<style>
  body {
    display: flex;
    justify-content: center;
    font-family: Arial, sans-serif;
  }
  #map-container {
    position: relative;
  }
  #map {
    width: 800px;
    height: 500px;
    background: #eef;
    border: 1px solid black;
    margin: 20px;
    position: relative;
  }
  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    position: absolute;
    cursor: pointer;
  }
  .victim { background-color: red; }
  .shelter { background-color: blue; }
  .repository { background-color: green; }
  .tooltip {
    position: absolute;
    padding: 8px 12px;
    background: white;
    border: 1px solid black;
    border-radius: 6px;
    display: none;
    font-size: 14px;
    pointer-events: none;
    z-index: 1000;
  }
  svg { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
  #info {
    margin: 20px;
    width: 250px;
  }
  #info h3 {
    margin-top: 0;
  }
  .info-section {
    margin-bottom: 20px;
  }
  .info-item {
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 6px 10px;
    margin-bottom: 6px;
    background: #fafafa;
  }
</style>
</head>
<body>
  <div id="map-container">
    <div id="map">
      <svg id="connections"></svg>
    </div>
  </div>

  <div id="info">
    <div class="info-section">
      <h3>Shelters</h3>
      <div id="shelter-info"></div>
    </div>
    <div class="info-section">
      <h3>Repositories</h3>
      <div id="repo-info"></div>
    </div>
  </div>

  <div id="tooltip" class="tooltip"></div>

<script>
const map = document.getElementById("map");
const tooltip = document.getElementById("tooltip");
const svg = document.getElementById("connections");
const DOT_SIZE = 8;
const DOT_RADIUS = DOT_SIZE / 2;

let victims = [];
let shelters = [];
let repositories = [];

// Scale coordinates
function scaleX(x){ return x / 100 * (map.clientWidth - DOT_SIZE); }
function scaleY(y){ return y / 100 * (map.clientHeight - DOT_SIZE); }

// Draw lines
function drawLine(x1, y1, x2, y2){
  const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
  line.setAttribute("x1", x1);
  line.setAttribute("y1", y1);
  line.setAttribute("x2", x2);
  line.setAttribute("y2", y2);
  line.setAttribute("stroke", "orange");
  line.setAttribute("stroke-width", 2);
  svg.appendChild(line);
}

// Draw dots with hover tooltip
function draw(){
  map.querySelectorAll(".dot").forEach(d => d.remove());
  while(svg.firstChild) svg.removeChild(svg.firstChild);

  // Victims
  victims.forEach(v => {
    const dot = document.createElement("div");
    dot.className = "dot victim";
    dot.style.left = scaleX(v.address_x) + "px";
    dot.style.top = scaleY(v.address_y) + "px";

    dot.addEventListener("mouseenter", () => {
      tooltip.innerHTML = `Victim ID: ${v.UID}<br>Name: ${v.name}`;
      tooltip.style.left = scaleX(v.address_x) + DOT_SIZE + "px";
      tooltip.style.top = scaleY(v.address_y) - 10 + "px";
      tooltip.style.display = "block";
    });
    dot.addEventListener("mouseleave", () => { tooltip.style.display = "none"; });

    map.appendChild(dot);
  });

  // Shelters
  shelters.forEach(s => {
    const dot = document.createElement("div");
    dot.className = "dot shelter";
    dot.style.left = scaleX(s.address_x) + "px";
    dot.style.top = scaleY(s.address_y) + "px";

    dot.addEventListener("mouseenter", () => {
      tooltip.innerHTML = `Shelter: ${s.address || "Unnamed"}<br>Supply: ${s.supply}`;
      tooltip.style.left = scaleX(s.address_x) + DOT_SIZE + "px";
      tooltip.style.top = scaleY(s.address_y) - 10 + "px";
      tooltip.style.display = "block";
    });
    dot.addEventListener("mouseleave", () => { tooltip.style.display = "none"; });

    map.appendChild(dot);
  });

  // Repositories
  repositories.forEach(r => {
    const dot = document.createElement("div");
    dot.className = "dot repository";
    dot.style.left = scaleX(r.address_x) + "px";
    dot.style.top = scaleY(r.address_y) + "px";

    dot.addEventListener("mouseenter", () => {
      tooltip.innerHTML = `Repository: ${r.repository_name}<br>Supply: ${r.supply.general}`;
      tooltip.style.left = scaleX(r.address_x) + DOT_SIZE + "px";
      tooltip.style.top = scaleY(r.address_y) - 10 + "px";
      tooltip.style.display = "block";
    });
    dot.addEventListener("mouseleave", () => { tooltip.style.display = "none"; });

    map.appendChild(dot);

    // Draw lines to shelters
    shelters.forEach(s => {
      drawLine(scaleX(r.address_x)+DOT_RADIUS, scaleY(r.address_y)+DOT_RADIUS,
               scaleX(s.address_x)+DOT_RADIUS, scaleY(s.address_y)+DOT_RADIUS);
    });
  });
}

// Update side info
function updateInfo(){
  const shelterDiv = document.getElementById("shelter-info");
  const repoDiv = document.getElementById("repo-info");
  shelterDiv.innerHTML = "";
  repoDiv.innerHTML = "";

  shelters.forEach(s => {
    const item = document.createElement("div");
    item.className = "info-item";
    item.innerHTML = `<strong>${s.address || "Unnamed"}</strong><br>Supply: ${s.supply}`;
    shelterDiv.appendChild(item);
  });

  repositories.forEach(r => {
    const item = document.createElement("div");
    item.className = "info-item";
    item.innerHTML = `<strong>${r.repository_name}</strong><br>Supply: ${r.supply.general}`;
    repoDiv.appendChild(item);
  });
}

// Fetch and draw
function fetchDataAndDraw(){
  Promise.all([
    fetch("http://127.0.0.1:5000/api/users").then(r=>r.json()),
    fetch("http://127.0.0.1:5000/api/shelters").then(r=>r.json()),
    fetch("http://127.0.0.1:5000/api/repositories").then(r=>r.json())
  ]).then(([v, s, r])=>{
    victims = v;
    shelters = s;
    repositories = r;
    draw();
    updateInfo();
  }).catch(err => console.error(err));
}

fetchDataAndDraw();
setInterval(fetchDataAndDraw, 1500);
window.addEventListener("resize", draw);
</script>
</body>
</html>
